var express = require('express');
var router = express.Router();
var UserModel = require('../modules/usermsg.js')
/* GET home page. */
var responseData;
router.use(function(req,res,next){
  responseData = {
    code:0,
    message:''
  }
  next();
})
router.post('/register', function(req, res, next) {
  var user = new UserModel({
    username:req.body.username,
    password:req.body.password
  })
  UserModel.findOne({'username':req.body.username})
  .then((userInfo)=>{
    if(userInfo){
      responseData.code = 410
      responseData.message = "用户名已被注册"
      res.json(responseData)
    }else{
      user.save((err,data)=>{
        if(err){
          console.log(err)
        }else{
          responseData.code = 200
          responseData.message = "注册成功"
          res.json(responseData)
        }
      })
    }
  })
});

router.post('/login',function(req,res,next){
    UserModel.findOne({'username':req.body.username})
    .then(userInfo=>{
      console.log(userInfo)
        if(userInfo){
            if(req.body.password == userInfo.password){
                responseData.code = 200
                responseData.message = "登陆成功"
                responseData.favlist = userInfo.favlist;
            }else{
                responseData.code = 411
                responseData.message = "密码不正确"
            }
        }else{
            responseData.code = 412
            responseData.message = "你还没有注册"
        }
        res.json(responseData)
    })
})

router.get('/all',function(req,res,next){
  UserModel.find({})
  .then(userInfo=>{  
      if(userInfo){
        responseData.code = 200
        responseData.message = userInfo
      }else{
          responseData.code = 400
          responseData.message = "暂无注册用户"
      }
      res.json(responseData)
  })
})

router.post('/del',function(req,res,next){
  UserModel.remove({'username':req.body.username,'password':req.body.password},function(err,data){
    if(err){
      responseData.code = 400
      responseData.message = "删除失败"
    }else{
      responseData.code = 200
      responseData.message = "删除成功"
    }
    res.json(responseData)
  })
})

//add喜欢
router.post('/addfav',function(req,res,next){
  UserModel.updateOne({'username':req.body.username},{'favlist':req.body.favlist},function(err,data){
    if(err){
      responseData.code = 400
      responseData.message = "添加失败"
    }else{
      responseData.code = 200
      responseData.message = "添加成功"
    }
    res.json(responseData)
  })
})

//get喜欢
router.get('/getfav',function(req,res,next){
  // console.log(req.query)
  UserModel.findOne({'username':req.query.username})
  .then(userInfo=>{
      if(userInfo){
          responseData.code = 200
          responseData.message = "获取成功"
          responseData.favlist = userInfo.favlist;
      }else{
          responseData.code = 404
          responseData.message = "皮一下很开心~"
      }
      res.json(responseData)
  })
})
module.exports = router;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
